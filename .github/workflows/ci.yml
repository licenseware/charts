name: ci

concurrency:
  cancel-in-progress: ${{ ! startsWith(github.ref, 'refs/tags/') }}
  group: ci-${{ github.ref_name }}-${{ github.event_name }}

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  HELM_VERSION: v3.14.0
  REGISTRY: ghcr.io

jobs:
  publish-charts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Package and Push Charts
        run: |
          find charts/ -name Chart.yaml | while IFS= read -r chartfile; do
            chart=$(dirname "$chartfile")
            helm dependency update "$chart"
            helm package -d registry/ "$chart"
          done
          # Push to OCI
          for pkg in registry/*.tgz; do
            helm push "$pkg" oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts
          done

      - name: Update registry index (gh-pages)
        run: helm repo index ./registry

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          keep_files: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./registry
          publish_branch: gh-pages
