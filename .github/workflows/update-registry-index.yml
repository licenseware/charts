name: update-registry-index

on:
  push:
    branches:
      - main

env:
  BRANCH: gh-pages
  HELM_VERSION: v3.10.0

jobs:
  update-registry-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ env.BRANCH }}
      - name: Update git config
        run: |
          git config --global user.email ${{ github.actor }}@users.noreply.github.com
          git config --global user.name ${{ github.actor }}
      - name: Merge from main
        run: git merge origin/main
      - name: Install Helm ${{ env.HELM_VERSION }}
        run: curl -fsSL https://git.io/get_helm.sh | bash
        env:
          DESIRED_VERSION: ${{ env.HELM_VERSION }}
      - name: Update chart packages
        run: |
          for chart in $(find charts/ -name Chart.yaml -exec dirname {} \;); do
            helm dep update $chart;
            helm package -d docs/ $chart;
          done
      - name: Update registry index
        run: helm repo index docs/
      - name: Publish to GitHub pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
